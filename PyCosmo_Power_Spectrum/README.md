# PyCosmo Power Spectrum Generator

This repository sets up a Python-based environment for computing cosmological power spectra using a custom wrapper built on PyCosmo and GSL (GNU Scientific Library). The build is managed using make.

## Project structure
```
PyCosmo_Power_Spectrum/
│
├── Functions/                     # Custom function modules
├── initial_conditions/            # Initial condition .csv files generated by N-GenIC
├── output_plots/                  # Plots of the powerspectrum generated by PyCosmo
├── outputted_power_spectrum/      # Power spectrum file generated by PyCosmo
├── parameter_files/               # Input parameter files read by PyCosmo
├── plotting/                      # .mplstyle file for generating plots and .ipynb file to visualise results
├── power_spectrum_generation/     # Main power spectrum generation code
├── tests/                         # Unit and integration tests
│
├── __init__.py                    # Package initializer
├── Makefile                       # Automation script for setup and execution
├── README.md                      # Project documentation
├── requirements.txt               # Python dependencies
├── .gitignore                     # Git ignore rules
├── .gitattributes                 # Git attributes config
```

## Requirements
* Python 3.9
* Make
* GSL (GNU Scientific Library)
* System Package Manager:
    * ```apt``` for Linux/WSL
    * ```brew``` for macOS

## Setup Instructions

### 1. Clone the repository

```bash
git clone https://github.com/your-repo/power-spectrum-generator.git
cd power-spectrum-generator
```

### 2. Run Setup

```bash
make setup
```

This will:
* Create a Python 3.9 virtual environment
* Install Python dependencies
* Install system dependencies (GSL, LaTeX tools, etc.)

If python3.9 is not found, install it using your system’s package manager.

### 3. Load modules for N-GenIC

## Installing N-GenIC
The N-GenIC code needs the following libraries:

GSL, HDF5, and FFTW.

On clusters, they can be loaded as modules. Example:

```
module load gsl/2.7
module load hdf5/1.10.8_slurm
```

### Install the correct version of FFTW
N-GenIC requires an older version of the FFTW code, namely version 2. This version can be installed from their website. To install the library at a specific path `path`, one can specify this with the `prefix` option. Furthermore, the options `shared` and `mpi` have to be enabled. 


```
wget https://www.fftw.org/fftw-2.1.5.tar.gz
tar -xvzf fftw-2.1.5.tar.gz
cd fftw-2.1.5
./configure --prefix=<path> --enable-shared --enable-mpi
make
make install
```

This will install the library in `path/lib/`. To make sure that during the compilation of N-GenIC, the library will be found, one can set 

`export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:path/lib/`

### Compile N-GenIC
To make sure that the FFTW library is found, one needs to specify in the `Makefile` inside the N-GenIC folder, the following two options, which specify the location of the previously installed FFTW library.

```
FFTW_INCL= -I path/include
FFTW_LIBS= -L path/lib
```

Then the source code can be compiled:

```
cd ngenic
make
```

The loading of the required modules can be automated by adding the following to your ~/.bash_profile:

```
PATH=$PATH:$HOME/.local/bin:$HOME/bin

export PATH

module purge
module load stack/2024-06
module load gcc/12.2.0
module load openmpi/4.1.6
module load gsl/2.7.1
module load fftw/2.1.5
```

## Usage

To run the main script with a specific parameter file:
```bash
make run PARAM=path/to/your_param_file.param
```

For example:
```bash
make run PARAM=parameter_files/pycosmo_input_32.param
```

This executes:
```bash
python -m power_spectrum_generation.custom_power_spectrum parameter_files/pycosmo_input_32.param
```

## Testing

Run unit tests:
```bash
make test
```

Run full test suite (clears cache, reinstalls system deps):
```bash
make test_full
```

## Cleaning 

Remove build artifacts, .pyc files, virtual environment:
```bash
make clean
```

To clear the sympy2c cache
```bash
make clear_cache
```